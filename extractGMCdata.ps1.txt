<#
Powershell script to extract GMC data using a list of GMC numbers

issues:
reuse of existing IE object fails, so need to quit and restart IE
even then it breaks regularly, so need to put it in an additional loop to catch these breaks
Most likely you'll need to check if all numbers were processed

#>

# consultants version (using econcur and wconcur from ODS)
#change window title
$host.ui.RawUI.WindowTitle = "GMC data consultants version"
# sure 'all loop' fires
$gmctocheck1 = "48" # for restart; first number in econcur
$gmctocheck = $gmctocheck1.PadLeft(7,'0')
$line = "somethingtostartwith"

for(;;) { # 'all loop'
  # stop if nothing left to do
  if ($line -eq $null){break}
  # get gmc number from previous loop that broke
  $gmctocheckold = $gmctocheck
  $justrestarted = $true

  # file with GMC numbers
  $inputfile = "S:\_ue\consgmc.csv"                                                  <# CHANGE #>
  $outputfile = "S:\_ue\consGMCdata.csv"                                             <# CHANGE #>
  $erroroutputfile = "S:\_ue\errorconsGMCdata.csv"                                   <# CHANGE #>
  # delete old output file
  #$fileexists = Test-Path $outputfile
  #if ($fileexists -eq $true) {
  #Remove-Item -Force -Path $outputfile  
  #}

  # header in output
  #Add-Content $outputfile "GMCNumber¬Surname¬GivenNames¬Gender¬Status¬PrimaryMedicalQualification¬ProvisionalRegistrationDate¬FullRegistrationDate¬SpecialistRegisterEntryDate¬GPRegistrationDate¬RevalidationInformation"
  #Add-Content $erroroutputfile "GMCNumber"

  $counter = 0
  $reader = [System.IO.File]::OpenText($inputfile)

  $nl = [Environment]::NewLine
  $data = $null
  $errordata = $null

  try { # 1st try
    for(;;) {
      $counter++
      $line = $reader.ReadLine()
      if ($line -eq $null){Return}
      # process the line
      # gmc website needs 7 digits
      $gmctocheck = $line.PadLeft(7,'0')
      # skip numbers already processed
      if ($justrestarted -eq $true) {
        if ($gmctocheck -ne $gmctocheckold){
          continue
        }else{
          $justrestarted = $false
        }
      }
      # Write-Host "GMC $gmctocheck"
      # initiate IE
      $ie3  = New-Object -com "InternetExplorer.Application"
      #$ie3.Visible = $true
      $url = "http://webcache.gmc-uk.org/gmclrmp_enu/start.swe?"
      $ie3.navigate($url)
      while ($ie3.busy) {
        start-sleep -milliseconds 100
      }
      while($ie3.ReadyState -ne 4) {start-sleep -m 100} 

      try { # 2nd try
        $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("gmcrefnumber").Value = $gmctocheck
        $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_3_1_10_0").Click()
        while($ie3.ReadyState -ne 4) {start-sleep -m 100} 
        while ($ie3.busy) {
          start-sleep -milliseconds 100
        }
        $gmcnumber = $null
        $gmcnumber = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_23_0").innerHTML
        $givennames = $null
        $givennames = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_36_0").innerHTML
        $surname = $null
        $surname = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_37_0").innerHTML
        $gender = $null
        $gender = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_35_0").innerHTML
        $status = $null
        $status = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_11_0").innerHTML
        #Write-Host "The GMC Number for GMC number $gmctocheck is $gmcnumber"
        #Write-Host "The surname for GMC number $gmctocheck is $surname"
        #Write-Host "The given name for GMC number $gmctocheck is $givennames"
        #Write-Host "The gender for GMC number $gmctocheck is $gender"
        #Write-Host "The status for GMC number $gmctocheck is $status"

        $primmedqual = $null
        $primmedqual = $ie3.document.frames.item(0).document.frames.item(1).document.getElementsByClassName("tablebodyfields")[13].innerHTML
        $provregdate = $null
        $provregdate = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_24_0").innerHTML
        $fullregdate = $null
        $fullregdate = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_4_0").innerHTML
        $specregentrydate = $null
        $specregentrydate = $ie3.document.frames.item(0).document.frames.item(1).document.getElementsByClassName("tablebodyfields")[18].innerHTML
        $gpregdate = $null
        $gpregdate = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_6_0").innerHTML
        $revalinfo = $null
        $revalinfo = $ie3.document.frames.item(0).document.frames.item(1).document.getElementById("s_2_1_1_0").innerHTML


        #Write-Host "The primary medical qualification for GMC number $gmctocheck is $primmedqual"
        #Write-Host "The provisional registration date for GMC number $gmctocheck is $provregdate"
        #Write-Host "The full registration date for GMC number $gmctocheck is $fullregdate"
        #Write-Host "The specialist register entry date for GMC number $gmctocheck is $specregentrydate"
        #Write-Host "The GP registration date for GMC number $gmctocheck is $gpregdate"
        #Write-Host "The Revalidation Information for GMC number $gmctocheck is $revalinfo"

  #      Add-Content $outputfile "$gmcnumber¬$surname¬$givennames¬$gender¬$status¬$primmedqual¬$provregdate¬$fullregdate¬$specregentrydate¬$gpregdate¬$revalinfo"
        $data = "$data$gmcnumber¬$surname¬$givennames¬$gender¬$status¬$primmedqual¬$provregdate¬$fullregdate¬$specregentrydate¬$gpregdate¬$revalinfo$nl"     
        
        $ie3.Quit()
        $ie3 = $null
        start-sleep -milliseconds 100
      }catch{ # 2nd catch
        $errordata = "$errordata$gmctocheck$nl"
        Write-Host "Error on $gmctocheck"
        $ie3.Quit()
        $ie3 = $null
        start-sleep -milliseconds 100

      } # 2nd try
    } # for loop
  }catch{ # 1st catch
     Write-Host "Error on 1st catch"
  }finally{
    $reader.Close()
  } # 1st try

  $ie3.Quit()
  $ie3 = $null
  start-sleep -milliseconds 100
  # flush data to file
  Add-Content $outputfile "$data"
  Add-Content $erroroutputfile "$errordata"
} # for loop all

# flush data to file after Ctrl-C: run this manually if needed
Add-Content $outputfile "$data"
Add-Content $erroroutputfile "$errordata"

